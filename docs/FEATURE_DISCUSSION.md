# DSE Speaking 功能讨论与规划

> 本文档用于记录项目新功能的讨论、构思和规划。  
> 每次讨论后更新状态，方便追踪进度。

---

## 📋 功能列表

| # | 功能名称 | 状态 | 优先级 |
|---|---------|------|--------|
| 1 | 用户设置 - 练测等级展示 | 💬 讨论中 | - |
| 2 | 用户设置 - 语言偏好 | 💬 讨论中 | - |
| 3 | 房间角色 - Marker（评分员） | 💬 讨论中 | - |
| 4 | 房间角色 - 观众（Spectator） | 💬 讨论中 | - |
| 5 | 各角色音视频权限设计 | 💬 讨论中 | - |
| 6 | Part B 完整流程 + 结果公布 + 自由讨论 | 💬 讨论中 | - |

---

## 1. 用户设置 - 练测等级展示

**提出日期：** 2026-02-11

### 描述

在「设置」页面中，让用户可以看到自己的练测等级（Practice Level）。这个等级可以反映用户在 DSE Speaking 练习中的表现和进步程度。

### 待讨论的问题

- **等级体系设计：** 等级怎么划分？是用 DSE 官方的 1-7 级（对应 U, 1, 2, 3, 4, 5, 5*, 5**），还是自定义一套练习等级？
- **等级计算方式：** 等级是用户自评、同伴互评，还是根据练习次数 / 时长自动计算？
- **展示形式：** 用数字、进度条、徽章、还是雷达图来展示？
- **是否公开：** 等级是否在房间列表 / 用户头像旁展示，方便匹配水平相近的队友？

### 初步想法

```
用户设置页
├── 个人资料
│   ├── 头像 / 昵称
│   ├── 练测等级（Level）  ← 新功能
│   └── ...
├── 语言偏好               ← 新功能
└── 账号设置
```

---

## 2. 用户设置 - 语言偏好

**提出日期：** 2026-02-11

### 描述

让用户在设置中标注自己熟练使用的语言，例如：

- **粤语（Cantonese）**
- **普通话（Mandarin）**
- **英语（English）**
- 其他语言

### 应用场景

- **房间匹配：** 用户可以找到说相同母语的队友，方便课外沟通 / 讨论策略
- **房间筛选：** 在房间列表中可以按语言偏好筛选
- **用户档案展示：** 在个人卡片上显示语言标签

### 待讨论的问题

- **多选 vs 单选：** 用户可以选多种语言吗？（比如粤语 + 普通话都流利）
- **熟练程度：** 是否需要标注熟练程度（如母语 / 流利 / 一般），还是只标注会说的语言？
- **跟房间的关系：** 创建房间时，是否可以设定「房间语言」来吸引同语言的人？

### 初步想法

语言偏好可以作为用户 profile 的一部分，存在 Supabase 的用户表中。大致的数据结构：

```sql
-- 可能的字段扩展（profiles 表）
ALTER TABLE profiles ADD COLUMN languages text[] DEFAULT '{}';
ALTER TABLE profiles ADD COLUMN practice_level int DEFAULT 0;
```

---

## 3. 房间角色 - Marker（评分员 / 考官）

**提出日期：** 2026-02-11

### 描述

除了现有的 4 位练习者（Candidate）之外，房间还支持一个 **Marker** 角色。Marker 模拟真实考试中的考官，负责观察讨论过程并给予评分或反馈。

### 角色定位

```
房间角色结构
├── Candidate × 4（练习者，参与讨论）
├── Marker × 1（评分员，观察 + 评分）
└── Spectator × ∞（观众，仅观看）
```

- Marker **不开启视频**（不需要露脸）
- Marker **有音频**（需要在 Part B 环节向考生提问）
- Marker **不参与** Part A 小组讨论发言
- Marker 在 Part B 阶段可以**开麦提出跟进问题**（模拟考官角色）
- Marker 可以对每位 Candidate 进行**评分 / 写评语**

### 待讨论的问题

- **谁可以当 Marker？** 任何人都可以？还是需要达到一定等级 / 获得资格？
- **评分体系：** Marker 按 DSE 官方四项标准打分（Pronunciation、Communication Strategy、Vocabulary、Ideas），还是简化版？
- **评分时机：** 实时边听边评，还是讨论结束后统一评分？
- **反馈机制：** Marker 的评分和评语怎么呈现给 Candidate？是即时的还是结束后查看？
- **Marker 限额：** 一个房间只允许 1 个 Marker，还是可以有多个？
- **Part B 互动：** Marker 在 Part B 个人回应阶段，是否由 Marker 来提问（像真正考官一样）？

### 初步想法

Marker 角色让练习更接近真实考试体验。可以考虑：
- 房间创建时可以设定「是否需要 Marker」
- Marker 有专属的评分界面，四项评分 + 文字评语
- 练习结束后，Candidate 可以查看 Marker 给的分数和反馈

---

## 4. 房间角色 - 观众（Spectator）

**提出日期：** 2026-02-11

### 描述

房间支持**无限制**数量的观众加入。观众只能观看和收听练习过程，不能发言或参与讨论。

### 角色定位

- 观众**不开启视频**，也**不开启音频**（纯旁听模式）
- 观众只能**收听** Candidate 的讨论音频
- 观众**不能**发言、不占 Candidate 名额
- 观众数量**不设上限**

### 应用场景

- **学习观摩：** 新手可以先看别人怎么练，学习讨论技巧和策略
- **老师旁听：** 老师 / 导师可以作为观众旁听学生的练习
- **朋友围观：** 朋友之间可以互相观摩，增加趣味性
- **直播 / 录播：** 未来可以扩展为公开观摩的练习赛

### 待讨论的问题

- **观众可见性：** 练习者能看到有多少观众在看吗？会不会造成压力？
  - 方案 A：显示观众数量但不显示具体是谁
  - 方案 B：完全隐藏观众存在
  - 方案 C：显示观众列表（透明模式）
- **观众互动：** 观众之间能不能聊天（文字弹幕 / 聊天室）？
- **权限控制：** 房间创建者能不能设置「禁止观众」或「仅限邀请观众」？
- **观众转换：** 如果有 Candidate 退出，观众能不能顶上变成练习者？
- **技术考量：** 大量观众的音视频分发需要考虑性能（可能需要用 SFU 架构或直播流方案）

### 初步想法

```
房间加入流程
│
├── 选择角色
│   ├── 🎤 Candidate（练习者）— 最多 4 人
│   ├── 📋 Marker（评分员）— 最多 1 人
│   └── 👀 Spectator（观众）— 不限人数
│
└── 进入房间
```

数据结构方面，`room_participants` 表可能需要加一个 `role` 字段：

```sql
-- room_participants 表扩展
-- role: 'candidate' | 'marker' | 'spectator'
ALTER TABLE room_participants ADD COLUMN role text DEFAULT 'candidate';
```

---

## 5. 各角色音视频权限设计

**提出日期：** 2026-02-11

### 权限矩阵

| 能力 | Candidate（练习者） | Marker（评分员） | Spectator（观众） |
|------|:---:|:---:|:---:|
| 视频（Camera） | ✅ 开启 | ❌ 不开启 | ❌ 不开启 |
| 音频（Mic） | ✅ 开启 | ✅ 有（Part B 提问用） | ❌ 不开启 |
| 收听他人音频 | ✅ | ✅ | ✅ |
| 观看他人视频 | ✅ | ✅ | ❌ 不显示 |
| Part A 发言 | ✅ 参与讨论 | ❌ 静音 | ❌ 静音 |
| Part B 提问 | ❌ | ✅ 模拟考官提问 | ❌ |
| Part B 回答 | ✅ | ❌ | ❌ |
| 评分 / 评语 | ❌ | ✅ | ❌ |

### 设计要点

- **Candidate**：完整的音视频体验，跟真实考试一样，开 camera + mic
- **Marker**：只需要音频通道，不露脸。Part A 期间保持静音，Part B 时开麦向考生提问。有专属的评分界面
- **Spectator**：最轻量级，不发送任何媒体流，只接收 Candidate 的音频。不显示视频画面，减少带宽消耗

### 技术考量

```
媒体流方向示意

Candidate ──video+audio──→ 所有 Candidate（互相可见）
Candidate ──audio only──→ Marker（Marker 听到讨论）
Candidate ──audio only──→ Spectator（观众旁听）

Marker ──audio──→ Candidate（仅 Part B 阶段）
Marker ──×──→ Spectator（Marker 不对观众广播）

Spectator ──×──→ 任何人（不发送任何流）
```

- Spectator 只接收音频流，不接收视频流，可以大幅节省带宽
- Marker 的 mic 可以在 Part A 阶段由系统自动静音，Part B 阶段自动开启
- 未来如果观众量大，可以考虑将 Candidate 的音频转为直播流（降低 WebRTC 连接数）

### 设计落地流程（实施版）

1. **权限建模（Token 层）**
   - Candidate: `canPublish=true, canSubscribe=true`
   - Marker: `canPublish=true, canSubscribe=true`（由客户端按阶段控麦）
   - Spectator: `canPublish=false, canSubscribe=true`

2. **阶段行为编排（Client 层）**
   - Candidate：保持现有流程（讨论可发言、个人回应仅当前 speaker 发言）
   - Marker：`preparing/discussing` 自动静音，`individual/finished` 允许开麦，始终禁用摄像头
   - Spectator：始终无麦克风/无摄像头

3. **媒体订阅策略（Bandwidth 层）**
   - Spectator 进入房间后强制音频订阅、视频退订（audio-only）
   - Spectator UI 不渲染视频墙，仅保留音频旁听状态
   - Marker 保留视频观看能力（看得到 Candidate 画面）

4. **界面与交互约束（UX 层）**
   - Marker 在讨论阶段麦克风按钮置灰并给出说明
   - Spectator 显示“旁听模式”提示，明确不可互动
   - Candidate 保持原有操作心智，不增加额外负担

5. **验收与回归（QA 层）**
   - 角色切换后重进房间，权限保持正确
   - Part A: Marker 无法开麦，Candidate 正常讨论
   - Part B: Marker 可开麦提问，Spectator 仍不可发言
   - Spectator 网络抓包可见不接收远端视频轨（仅音频轨）

---

## 6. Part B 完整流程 + 结果公布 + 自由讨论

**提出日期：** 2026-02-11

### 完整会话阶段流程

```
┌─────────────────────────────────────────────────────────────────┐
│  Phase 1 ─ 准备阶段（10 min）                                    │
│  所有 Candidate 阅读材料、做笔记                                   │
├─────────────────────────────────────────────────────────────────┤
│  Phase 2 ─ Part A 小组讨论（8 min / 6 min）                      │
│  4 人自由讨论，Marker 静音旁听                                     │
├─────────────────────────────────────────────────────────────────┤
│  Phase 3 ─ Part B 个人回应（每人 60 秒）  ← 本节重点               │
│  Marker 逐一向考生提问，考生限时回答                                │
├─────────────────────────────────────────────────────────────────┤
│  Phase 4 ─ 结果公布                                              │
│  展示 Marker 评分，Marker 开麦给建议                               │
├─────────────────────────────────────────────────────────────────┤
│  Phase 5 ─ 自由讨论（无限时）                                     │
│  所有人可开麦自由交流，直到全部离开房间自动解散                       │
└─────────────────────────────────────────────────────────────────┘
```

---

### Phase 3 详细流程 ─ Part B 个人回应

这是 Marker 主导的环节，逐一对每位 Candidate 进行提问。

#### 3.1 Marker 选题

- Marker 从题库中为**当前考生**选择一道 Part B 跟进问题
- 选题后，问题**不会立即显示**，先进入倒数环节

#### 3.2 倒数准备（3-2-1）

- 屏幕中央出现**大字倒数 3 → 2 → 1**
- **所有人**都能看到这个倒数效果（Candidate、Marker、Spectator）
- 让当前考生做好心理准备

#### 3.3 问题显示 + 60 秒计时

- 倒数结束后：
  - **问题文本**显示在屏幕上，所有人可见
  - **60 秒倒计时**自动启动，显示在问题旁边
  - 当前考生开始回答
- 计时器所有人可见（Candidate、Marker、Spectator）
- 只有当前被提问的考生应该回答，其他 Candidate 保持静音

#### 3.4 时间到 → 自动停止

- 60 秒一到，**自动截止**
  - 当前考生的麦克风可以被系统自动静音
  - 屏幕显示「时间到」提示
- Marker 不需要手动操作停止

#### 3.5 轮到下一位

- Marker 为**下一位考生**选择问题
- 重复 3.1 → 3.4 流程
- 直到所有 Candidate（最多 4 人）都完成

```
Part B 流程示意（以 4 位考生为例）

Marker 选题 → [3-2-1 倒数] → 问题显示 + 60s 计时 → 时间到
   │                                                    │
   │              ┌── Candidate 1 回答 ──┘              │
   │              │                                      ▼
   └──────────────┤  Marker 为下一位选题
                  │
                  ├── Candidate 2：同上流程
                  ├── Candidate 3：同上流程
                  └── Candidate 4：同上流程
                                    │
                                    ▼
                            所有人完成 → Phase 4
```

#### Marker 端界面

```
┌────────────────────────────────────┐
│  Part B - 个人回应                  │
│                                    │
│  当前考生：Candidate 1 / 4         │
│                                    │
│  [选择问题 ▼]                      │
│  ┌──────────────────────────────┐  │
│  │ Q: What would you suggest... │  │
│  │ Q: Do you think that...     │  │
│  │ Q: How important is...      │  │
│  └──────────────────────────────┘  │
│                                    │
│  [ 确认出题 → 开始倒数 ]            │
│                                    │
│  ─── 评分区域 ───                  │
│  Pronunciation:  ★★★★☆            │
│  Communication:  ★★★☆☆            │
│  Vocabulary:     ★★★★☆            │
│  Ideas:          ★★★☆☆            │
│  评语: [________________]          │
└────────────────────────────────────┘
```

#### 考生端 / 观众端界面

```
┌─────────────────────────────────────────┐
│  Part B - 个人回应                       │
│                                         │
│  当前：Candidate 1                       │
│                                         │
│  ┌─────────────────────────────┐  ⏱ 45s │
│  │                             │        │
│  │  "What would you suggest    │        │
│  │   to improve the situation  │        │
│  │   mentioned in the article?"│        │
│  │                             │        │
│  └─────────────────────────────┘        │
│                                         │
│  ● Candidate 1 正在回答...               │
└─────────────────────────────────────────┘
```

---

### Phase 4 详细流程 ─ 结果公布

Part B 全部完成后，进入结果公布阶段。

#### 4.1 成绩展示

- 屏幕显示 Marker 对**每位 Candidate** 的评分
- **所有人可见**：Candidate、Marker、Spectator 都能看到
- 展示内容包括：
  - 四项评分（Pronunciation、Communication Strategy、Vocabulary、Ideas）
  - Marker 的文字评语

#### 4.2 Marker 语音反馈

- 此阶段 Marker **可以开麦**
- Marker 对所有考生进行口头反馈 / 建议
- 所有人都能听到 Marker 的语音

```
结果展示界面（所有人可见）

┌──────────────────────────────────────────────────┐
│  练习结果                                         │
│                                                  │
│  ┌─ Candidate 1 ──────────────────────────────┐  │
│  │  Pronunciation: ★★★★☆  Communication: ★★★☆☆│  │
│  │  Vocabulary:    ★★★★☆  Ideas:         ★★★☆☆│  │
│  │  评语："Good use of examples, try to..."    │  │
│  └────────────────────────────────────────────┘  │
│  ┌─ Candidate 2 ──────────────────────────────┐  │
│  │  ...                                       │  │
│  └────────────────────────────────────────────┘  │
│  ...                                             │
│                                                  │
│  🎙 Marker 正在语音反馈中...                      │
└──────────────────────────────────────────────────┘
```

---

### Phase 5 详细流程 ─ 自由讨论

#### 5.1 全员开放

- 结果公布结束后，自动进入**自由讨论**模式
- **所有角色**（Candidate、Marker、Spectator）都可以：
  - 开启麦克风发言
  - 自由交流、提问、讨论
- 不设时间限制，可以无限停留

#### 5.2 音视频权限变更

| 能力 | Phase 1-4 期间 | Phase 5 自由讨论 |
|------|:---:|:---:|
| Candidate Mic | 按阶段规则 | ✅ 自由开麦 |
| Marker Mic | Part B 才开 | ✅ 自由开麦 |
| Spectator Mic | ❌ 静音 | ✅ 可以开麦发言 |
| 所有人 Video | 按角色规则 | 维持不变（可讨论） |

#### 5.3 房间生命周期

- 自由讨论阶段**无时间限制**
- 参与者可以随时离开
- **当最后一个人离开时，房间自动解散**
- 房间解散后，练习记录（评分、评语）保存到数据库，供日后查看

```
房间生命周期

创建房间 → 等待加入 → Phase 1~4 练习 → Phase 5 自由讨论
                                                │
                              有人在 ← 继续保持 ─┤
                                                │
                              全部离开 → 房间解散 → 记录归档
```

---

## 🗓 讨论记录

### 2026-02-11 - 初始讨论

- 提出了两个新功能方向：练测等级 + 语言偏好
- 下一步：确定等级体系和语言选项的具体设计

### 2026-02-11 - 房间角色讨论

- 新增 Marker（评分员）角色：1 人，负责评分和 Part B 提问
- 新增 Spectator（观众）角色：不限人数，仅观看
- 房间角色结构确定为：Candidate × 4 + Marker × 1 + Spectator × ∞

### 2026-02-11 - 音视频权限确认

- **确认：** Marker 和 Spectator 都不开视频
- **确认：** Marker 有音频（Part B 提问需要）
- **确认：** Spectator 纯旁听，不发送任何媒体流，只接收音频
- 整理了完整的角色权限矩阵

### 2026-02-11 - Part B 及后续流程确认

- **确认 Part B 流程：** Marker 选题 → 3-2-1 倒数（全员可见）→ 问题显示 + 60s 计时 → 时间到自动停止 → 下一位考生
- **确认结果公布：** 所有人（Candidate + Marker + Spectator）都能看到 Marker 的评分和评语
- **确认 Marker 反馈：** 结果公布时 Marker 可开麦给建议
- **确认自由讨论：** Phase 5 所有角色（含 Spectator）都可开麦自由交流，无时间限制
- **确认房间解散规则：** 所有人离开后房间自动解散，记录归档
- 下一步：讨论评分体系细节、UI 布局

### 2026-02-12 - 第 5 项音视频权限开始实施

- 已将 Marker 从“纯观察者”中拆分，允许发布音频能力（由阶段逻辑控麦）
- 已实现 Spectator audio-only 模式：不显示视频，且客户端强制只订阅音频轨
- 已在 Session 侧区分 `isSpectator` / `isMarker`，不再共用同一套观察者媒体逻辑
- 当前可作为第 5 项的首版可运行基线，后续再迭代 Phase 5（自由讨论全员开麦）策略

---

*最后更新：2026-02-12*
